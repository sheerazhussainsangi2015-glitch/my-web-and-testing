<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAS Student Registry Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-gas': '#1a73e8', /* Google Blue */
                        'secondary-gray': '#f3f4f6',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for better aesthetics */
        body { font-family: 'Inter', sans-serif; }
        .form-input { @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-gas focus:border-primary-gas transition duration-150 shadow-sm; }
        .btn-primary { @apply w-full py-3 px-4 rounded-lg font-semibold text-white transition duration-200 shadow-lg bg-primary-gas hover:bg-blue-600 active:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed; }
    </style>
</head>
<body class="bg-secondary-gray min-h-screen p-4 sm:p-8">

    <!-- WARNING MODAL -->
    <div id="warning-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-lg w-full">
            <h3 class="text-xl font-bold text-red-600 mb-4">⚠️ Security Alert!</h3>
            <p class="text-gray-700 mb-4">
                This web app uses a **simulated, insecure login system** by storing credentials in a Google Sheet. 
                **DO NOT use real passwords.** This is for demonstration only, as Google Apps Script is not built for secure custom authentication.
            </p>
            <button id="close-warning" class="btn-primary bg-red-500 hover:bg-red-600">I Understand and Proceed</button>
        </div>
    </div>
    <!-- END WARNING MODAL -->

    <div class="max-w-4xl mx-auto flex flex-col items-center">
        <!-- Header -->
        <header class="w-full mb-8">
            <h1 class="text-4xl font-extrabold text-primary-gas border-b-4 border-blue-400 pb-3">
                GAS Student Registry Portal
            </h1>
            <p id="auth-status" class="text-sm text-gray-600 mt-2 font-medium">
                Status: Awaiting action.
            </p>
        </header>

        <!-- Message Box -->
        <div id="message-box" class="w-full p-3 mb-6 rounded-lg font-medium shadow-md hidden" role="alert"></div>

        <!-- Authentication and Registration Container -->
        <div class="w-full bg-white p-6 sm:p-8 rounded-xl shadow-2xl mb-10 border border-gray-100 flex flex-col md:flex-row gap-8">
            
            <!-- Authentication Forms (Left/Top) -->
            <div id="auth-section" class="w-full md:w-1/2">
                <h2 class="text-2xl font-bold text-gray-700 mb-6">User Access</h2>
                
                <!-- Auth Tabs -->
                <div id="auth-tabs" class="flex border-b mb-6">
                    <button id="tab-login" class="py-2 px-4 text-center font-semibold border-b-2 border-primary-gas text-primary-gas transition duration-150">Login</button>
                    <button id="tab-signup" class="py-2 px-4 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-primary-gas transition duration-150">Sign Up</button>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="space-y-4">
                    <input type="hidden" name="action" value="login">
                    <div class="space-y-1">
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="login-email" name="email" required class="form-input" placeholder="you@example.com">
                    </div>
                    <div class="space-y-1">
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" name="password" required class="form-input" placeholder="******">
                    </div>
                    <button type="submit" id="login-btn" class="btn-primary">
                        Log In
                    </button>
                </form>

                <!-- Sign Up Form (Initially hidden) -->
                <form id="signup-form" class="space-y-4 hidden">
                    <input type="hidden" name="action" value="signup">
                    <div class="space-y-1">
                        <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="signup-email" name="email" required class="form-input" placeholder="create your email">
                    </div>
                    <div class="space-y-1">
                        <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="signup-password" name="password" required class="form-input" placeholder="min 6 characters">
                    </div>
                    <button type="submit" id="signup-btn" class="btn-primary">
                        Create Account
                    </button>
                </form>

                <!-- User Profile / Logout (Initially hidden) -->
                <div id="profile-card" class="space-y-4 p-4 border border-blue-200 bg-blue-50 rounded-lg hidden">
                    <p class="font-bold text-lg text-primary-gas">Welcome Back!</p>
                    <p class="text-sm text-gray-700 truncate">Logged in as: <span id="user-email" class="font-mono text-xs text-blue-800 bg-blue-100 p-1 rounded"></span></p>
                    <button id="logout-btn" class="w-full py-2 px-4 rounded-lg font-semibold text-primary-gas bg-blue-200 hover:bg-blue-300 transition duration-200">
                        Log Out
                    </button>
                </div>
            </div>

            <!-- Student Registration Form (Right/Bottom) -->
            <div id="registration-section" class="w-full md:w-1/2 md:border-l md:pl-8 border-gray-200">
                <h2 class="text-2xl font-bold text-gray-700 mb-6">Register Student</h2>
                <div id="reg-access-warning" class="p-4 bg-yellow-100 text-yellow-800 rounded-lg mb-4 text-sm font-medium">
                    Please Log In or Sign Up to register a new student record.
                </div>
                
                <form id="register-form" class="space-y-4 hidden">
                    <input type="hidden" name="action" value="register">
                    <input type="hidden" id="registered-by-email" name="registeredBy" value="">
                    <div>
                        <label for="reg-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="reg-name" name="name" required class="form-input" placeholder="Enter full name">
                    </div>
                    <div>
                        <label for="reg-email" class="block text-sm font-medium text-gray-700 mb-1">Student Email</label>
                        <input type="email" id="reg-email" name="studentEmail" required class="form-input" placeholder="student@university.edu">
                    </div>
                    <button type="submit" id="register-btn" class="btn-primary">
                        Register Student Record
                    </button>
                    <p class="text-xs text-gray-500 mt-4 italic">Note: This record is visible to all users in the table below.</p>
                </form>
            </div>
        </div>

        <!-- Registered Students Table -->
        <div class="w-full bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-100 mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 flex justify-between items-center">
                Registered Students Registry
                <span id="student-count" class="text-sm font-normal text-gray-500">Total: 0</span>
            </h2>
            
            <p id="data-loading-status" class="text-center py-8 text-gray-500">Loading student data from Google Sheet...</p>

            <div class="overflow-x-auto rounded-lg shadow-inner border border-gray-200 hidden" id="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Timestamp</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider hidden sm:table-cell">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider hidden md:table-cell">Registered By</th>
                        </tr>
                    </thead>
                    <tbody id="students-tbody" class="bg-white divide-y divide-gray-100">
                        <!-- Student rows will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // PASTE YOUR DEPLOYED GOOGLE APPS SCRIPT WEB APP URL HERE
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwAedbTghrO10YxXeW8UP8RpHrQpLanWTjilDpWhimVMHymGSqeyFw8X_o1Jj39-Jjq/exec'; 
        
        // --- UI Elements ---
        const messageBox = document.getElementById('message-box');
        const authStatus = document.getElementById('auth-status');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const registerForm = document.getElementById('register-form');
        const regAccessWarning = document.getElementById('reg-access-warning');
        const profileCard = document.getElementById('profile-card');
        const userEmailDisplay = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const tabLogin = document.getElementById('tab-login');
        const tabSignup = document.getElementById('tab-signup');
        const studentsTbody = document.getElementById('students-tbody');
        const dataLoadingStatus = document.getElementById('data-loading-status');
        const studentCount = document.getElementById('student-count');
        const tableContainer = document.getElementById('table-container');
        const registeredByEmailInput = document.getElementById('registered-by-email');
        const warningModal = document.getElementById('warning-modal');
        const closeWarningBtn = document.getElementById('close-warning');


        // --- UTILITIES ---

        function showMessage(type, text) {
            messageBox.textContent = text;
            messageBox.className = `w-full max-w-4xl p-3 mb-6 rounded-lg font-medium shadow-md ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            messageBox.classList.remove('hidden');
        }

        function clearMessage() {
            messageBox.classList.add('hidden');
        }

        function switchAuthTab(isLogin) {
            if (isLogin) {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                tabLogin.classList.add('border-primary-gas', 'text-primary-gas');
                tabLogin.classList.remove('border-transparent', 'text-gray-500');
                tabSignup.classList.remove('border-primary-gas', 'text-primary-gas');
                tabSignup.classList.add('border-transparent', 'text-gray-500');
            } else {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                tabSignup.classList.add('border-primary-gas', 'text-primary-gas');
                tabSignup.classList.remove('border-transparent', 'text-gray-500');
                tabLogin.classList.remove('border-primary-gas', 'text-primary-gas');
                tabLogin.classList.add('border-transparent', 'text-gray-500');
            }
            clearMessage();
        }

        /**
         * Simulates session management using sessionStorage.
         * @returns {string | null} The logged-in user's email or null.
         */
        function getLoggedInUser() {
            return sessionStorage.getItem('loggedInUserEmail');
        }
        
        /**
         * Updates the UI based on the simulated session state.
         */
        function updateUI() {
            const userEmail = getLoggedInUser();
            const isLoggedIn = !!userEmail;

            if (isLoggedIn) {
                authStatus.innerHTML = `<span class='font-semibold text-green-600'>Logged In: ${userEmail}</span>`;
                userEmailDisplay.textContent = userEmail;
                
                // Show profile/logout, hide login/signup forms/tabs
                profileCard.classList.remove('hidden');
                loginForm.classList.add('hidden');
                signupForm.classList.add('hidden');
                document.getElementById('auth-tabs').classList.add('hidden');

                // Show registration form
                registerForm.classList.remove('hidden');
                regAccessWarning.classList.add('hidden');
                registeredByEmailInput.value = userEmail;
            } else {
                authStatus.innerHTML = `<span class='font-semibold text-gray-600'>Status: Logged Out</span>`;

                // Hide profile/logout, show login/signup forms/tabs
                profileCard.classList.add('hidden');
                switchAuthTab(true); // Default to login tab
                document.getElementById('auth-tabs').classList.remove('hidden');

                // Hide registration form, show warning
                registerForm.classList.add('hidden');
                regAccessWarning.classList.remove('hidden');
                registeredByEmailInput.value = '';
            }
        }
        
        /**
         * Handles POST requests for login and signup.
         * @param {FormData} formData Form data object containing action, email, and password.
         * @param {HTMLButtonElement} button The submit button element.
         */
        async function handleAuth(formData, button) {
            button.disabled = true;
            button.textContent = 'Processing...';
            clearMessage();

            try {
                // Convert FormData to URL-encoded string
                const formDataString = new URLSearchParams(formData).toString();
                
                const response = await fetch(scriptURL, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formDataString
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success) {
                    sessionStorage.setItem('loggedInUserEmail', data.email);
                    showMessage('success', data.message);
                    updateUI(); // Update UI to logged-in state
                    // Fetch data immediately after successful auth/signup
                    fetchData(); 
                } else {
                    showMessage('error', data.message);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                showMessage('error', `A network error occurred: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = formData.get('action') === 'login' ? 'Log In' : 'Create Account';
            }
        }

        /**
         * Handles POST request for registering a student.
         * @param {FormData} formData Form data object.
         * @param {HTMLButtonElement} button The submit button element.
         */
        async function handleRegistration(formData, button) {
            button.disabled = true;
            button.textContent = 'Registering...';
            clearMessage();

            try {
                // Convert FormData to URL-encoded string
                const formDataString = new URLSearchParams(formData).toString();
                
                const response = await fetch(scriptURL, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formDataString
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success) {
                    showMessage('success', data.message);
                    registerForm.reset();
                    fetchData(); // Refresh table
                } else {
                    showMessage('error', data.message);
                }
            } catch (error) {
                console.error("Registration Error:", error);
                showMessage('error', `A network error occurred: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Register Student Record';
            }
        }


        /**
         * Fetches student data from the Google Apps Script (doGet).
         */
        async function fetchData() {
            dataLoadingStatus.textContent = 'Loading student data from Google Sheet...';
            dataLoadingStatus.classList.remove('hidden');
            tableContainer.classList.add('hidden');

            try {
                const response = await fetch(scriptURL, { 
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success && Array.isArray(data.data)) {
                    renderTable(data.data);
                } else {
                    throw new Error(data.message || 'Invalid data structure received.');
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                dataLoadingStatus.textContent = 'Error loading data: ' + error.message;
                dataLoadingStatus.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            }
        }
        
        /**
         * Renders the fetched data into the HTML table.
         * @param {Array<Object>} data The array of student objects.
         */
        function renderTable(data) {
            studentsTbody.innerHTML = '';
            studentCount.textContent = `Total: ${data.length}`;

            if (data.length === 0) {
                dataLoadingStatus.textContent = 'No students registered yet.';
                dataLoadingStatus.classList.remove('hidden');
                tableContainer.classList.add('hidden');
                return;
            }

            data.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${student.Timestamp}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${student.Name}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${student.StudentEmail}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-400 hidden md:table-cell">${student.RegisteredBy}</td>
                `;
                studentsTbody.appendChild(row);
            });

            dataLoadingStatus.classList.add('hidden');
            tableContainer.classList.remove('hidden');
        }

        // --- Event Listeners Setup ---

        document.addEventListener('DOMContentLoaded', () => {
            // Show warning modal on load
            warningModal.classList.remove('hidden');
            
            // Close warning modal and start loading data
            closeWarningBtn.addEventListener('click', () => {
                warningModal.classList.add('hidden');
                updateUI();
                fetchData();
            });
        });

        // Tabs
        tabLogin.addEventListener('click', () => switchAuthTab(true));
        tabSignup.addEventListener('click', () => switchAuthTab(false));

        // Forms
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleAuth(new FormData(loginForm), document.getElementById('login-btn'));
        });

        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleAuth(new FormData(signupForm), document.getElementById('signup-btn'));
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleRegistration(new FormData(registerForm), document.getElementById('register-btn'));
        });
        
        // Logout
        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('loggedInUserEmail');
            showMessage('success', 'You have been logged out.');
            updateUI();
        });
    </script>
</body>
</html>

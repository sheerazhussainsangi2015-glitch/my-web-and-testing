<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets Connection Diagnostic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .test-section.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .test-section.success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .test-section.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .test-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .test-header h3 {
            color: #333;
            font-size: 1.3rem;
        }

        .status-icon {
            font-size: 1.5rem;
        }

        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }
        .status-warning { color: #ffc107; }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 10px 5px;
            transition: background 0.3s;
            text-decoration: none;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .code-block {
            background: #2d2d39;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 10px 0;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .url-display {
            background: #e9ecef;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
            border: 1px solid #ced4da;
        }

        .step {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #6c757d;
        }

        .step-number {
            display: inline-block;
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }

        .log-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .solution-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .test-results {
            margin-top: 20px;
        }

        .result-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #6c757d;
        }

        .result-item.success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .result-item.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Google Sheets Connection Diagnostic</h1>
        
        <!-- Connection Test Section -->
        <div class="test-section" id="connectionTest">
            <div class="test-header">
                <i class="fas fa-plug status-icon status-offline" id="connectionIcon"></i>
                <h3>Connection Test</h3>
            </div>
            
            <div class="url-display">
                Current API URL: <span id="currentUrl">https://script.google.com/macros/s/AKfycbx77-WWWNOlwD1rK_8Ip9CzNbZqBUQjprAazBRx2AJ-nIxVKuTCJqUWvdJ96OjD_t__/exec</span>
            </div>
            
            <p id="connectionStatus">Testing connection to Google Apps Script...</p>
            
            <button class="btn" onclick="runFullDiagnostic()">
                <i class="fas fa-play"></i>
                <span>Run Full Diagnostic</span>
            </button>
            
            <div class="test-results" id="connectionResults"></div>
        </div>

        <!-- Deployment Guide Section -->
        <div class="test-section warning">
            <div class="test-header">
                <i class="fas fa-cogs status-icon status-warning"></i>
                <h3>Deployment Checklist</h3>
            </div>
            
            <div class="step">
                <span class="step-number">1</span>
                <strong>Create Google Apps Script</strong>
                <p>Go to <a href="https://script.google.com" target="_blank">script.google.com</a> and create a new project.</p>
            </div>
            
            <div class="step">
                <span class="step-number">2</span>
                <strong>Paste This Code</strong>
                <div class="code-block">
// Simple Diagnostic Backend
function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  const result = {
    success: true,
    message: "Hello from Google Apps Script!",
    timestamp: new Date().toISOString(),
    parameters: e.parameters
  };
  
  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
      'Access-Control-Allow-Origin': '*'
    });
}
                </div>
            </div>
            
            <div class="step">
                <span class="step-number">3</span>
                <strong>Deploy as Web App</strong>
                <ul>
                    <li>Click <strong>Deploy</strong> ‚Üí <strong>New deployment</strong></li>
                    <li>Select <strong>Web App</strong> as type</li>
                    <li><strong>Execute as:</strong> Me</li>
                    <li><strong>Who has access:</strong> Anyone</li>
                    <li>Click <strong>Deploy</strong></li>
                    <li><strong>Copy the Web App URL</strong></li>
                </ul>
            </div>
            
            <div class="step">
                <span class="step-number">4</span>
                <strong>Update URL Here</strong>
                <p>Paste your deployment URL below:</p>
                <input type="text" id="newApiUrl" placeholder="Paste your Web App URL here" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px;">
                <button class="btn btn-success" onclick="updateApiUrl()">
                    <i class="fas fa-save"></i>
                    Update API URL
                </button>
            </div>
        </div>

        <!-- Manual Test Section -->
        <div class="test-section">
            <div class="test-header">
                <i class="fas fa-vial status-icon"></i>
                <h3>Manual Tests</h3>
            </div>
            
            <button class="btn" onclick="testDirectFetch()">
                <i class="fas fa-exchange-alt"></i>
                Test Direct Fetch
            </button>
            
            <button class="btn" onclick="testJsonp()">
                <i class="fas fa-code"></i>
                Test JSONP
            </button>
            
            <button class="btn" onclick="testCorsProxy()">
                <i class="fas fa-server"></i>
                Test with CORS Proxy
            </button>
            
            <div class="log-output" id="manualTestLog"></div>
        </div>

        <!-- Solution Section -->
        <div class="solution-box">
            <h4>üö® Common Solutions:</h4>
            <ul>
                <li><strong>Check Deployment:</strong> Make sure your script is deployed as "Web App" not "API Executable"</li>
                <li><strong>Permissions:</strong> Set "Execute as: Me" and "Who has access: Anyone"</li>
                <li><strong>Authorization:</strong> You might need to authorize the script the first time</li>
                <li><strong>CORS:</strong> Google Apps Script has CORS issues - we need to handle them</li>
                <li><strong>URL Format:</strong> Make sure your URL ends with <code>/exec</code></li>
            </ul>
        </div>
    </div>

    <script>
        const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbx77-WWWNOlwD1rK_8Ip9CzNbZqBUQjprAazBRx2AJ-nIxVKuTCJqUWvdJ96OjD_t__/exec';
        let currentApiUrl = DEFAULT_API_URL;

        function updateApiUrl() {
            const newUrl = document.getElementById('newApiUrl').value.trim();
            if (newUrl) {
                currentApiUrl = newUrl;
                document.getElementById('currentUrl').textContent = newUrl;
                document.getElementById('connectionTest').className = 'test-section warning';
                document.getElementById('connectionStatus').textContent = 'URL updated. Run diagnostic again.';
            }
        }

        async function runFullDiagnostic() {
            const resultsDiv = document.getElementById('connectionResults');
            const connectionIcon = document.getElementById('connectionIcon');
            const connectionStatus = document.getElementById('connectionStatus');
            
            resultsDiv.innerHTML = '';
            connectionIcon.className = 'fas fa-sync-alt status-icon status-warning';
            connectionStatus.textContent = 'Running diagnostic tests...';

            const tests = [
                testUrlFormat,
                testDirectConnection,
                testWithCorsProxy,
                testWithJsonp,
                testAlternativeMethods
            ];

            for (const test of tests) {
                await test();
                await new Promise(resolve => setTimeout(resolve, 1000)); // Delay between tests
            }

            connectionIcon.className = 'fas fa-check-circle status-icon status-online';
            connectionStatus.textContent = 'Diagnostic complete! Check results below.';
        }

        async function testUrlFormat() {
            addResult('URL Format Check', 'Checking if URL format is correct...');
            
            if (!currentApiUrl.includes('script.google.com')) {
                addResult('URL Format Check', '‚ùå URL does not contain script.google.com', 'error');
                return false;
            }
            
            if (!currentApiUrl.endsWith('/exec')) {
                addResult('URL Format Check', '‚ùå URL should end with /exec', 'error');
                return false;
            }
            
            addResult('URL Format Check', '‚úÖ URL format looks correct', 'success');
            return true;
        }

        async function testDirectConnection() {
            addResult('Direct Connection', 'Testing direct connection...');
            
            try {
                const startTime = Date.now();
                const response = await fetch(currentApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=test'
                });
                const endTime = Date.now();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                const data = JSON.parse(text);
                
                addResult('Direct Connection', `‚úÖ Connected successfully (${endTime - startTime}ms)`, 'success');
                addResult('Response Data', `Server says: ${data.message || 'Connected!'}`, 'success');
                return true;
                
            } catch (error) {
                addResult('Direct Connection', `‚ùå Failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testWithCorsProxy() {
            addResult('CORS Proxy Test', 'Testing with CORS proxy...');
            
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            
            try {
                const response = await fetch(proxyUrl + currentApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: 'action=test'
                });
                
                if (response.ok) {
                    const text = await response.text();
                    addResult('CORS Proxy Test', '‚úÖ Connected via CORS proxy', 'success');
                    return true;
                } else {
                    throw new Error(`Proxy returned ${response.status}`);
                }
            } catch (error) {
                addResult('CORS Proxy Test', `‚ùå CORS proxy failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testWithJsonp() {
            addResult('JSONP Test', 'Testing JSONP method...');
            
            return new Promise((resolve) => {
                const callbackName = 'jsonp_callback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    addResult('JSONP Test', '‚úÖ JSONP connection successful', 'success');
                    resolve(true);
                };
                
                script.src = `${currentApiUrl}?action=test&callback=${callbackName}`;
                script.onerror = function() {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    addResult('JSONP Test', '‚ùå JSONP failed - script load error', 'error');
                    resolve(false);
                };
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                        delete window[callbackName];
                        addResult('JSONP Test', '‚ùå JSONP timeout', 'error');
                        resolve(false);
                    }
                }, 10000);
                
                document.body.appendChild(script);
            });
        }

        async function testAlternativeMethods() {
            addResult('Alternative Methods', 'Testing other connection methods...');
            
            // Test 1: Simple GET request
            try {
                const response = await fetch(currentApiUrl);
                if (response.ok) {
                    addResult('GET Request', '‚úÖ GET request successful', 'success');
                } else {
                    addResult('GET Request', `‚ùå GET failed: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult('GET Request', `‚ùå GET error: ${error.message}`, 'error');
            }
            
            // Test 2: Different content type
            try {
                const response = await fetch(currentApiUrl, {
                    method: 'POST',
                    body: JSON.stringify({action: 'test'}),
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                if (response.ok) {
                    addResult('JSON POST', '‚úÖ JSON POST successful', 'success');
                } else {
                    addResult('JSON POST', `‚ùå JSON POST failed: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult('JSON POST', `‚ùå JSON POST error: ${error.message}`, 'error');
            }
        }

        function addResult(testName, message, type = 'info') {
            const resultsDiv = document.getElementById('connectionResults');
            const resultItem = document.createElement('div');
            resultItem.className = `result-item ${type}`;
            resultItem.innerHTML = `<strong>${testName}:</strong> ${message}`;
            resultsDiv.appendChild(resultItem);
        }

        // Manual test functions
        async function testDirectFetch() {
            const log = document.getElementById('manualTestLog');
            log.textContent = 'Testing direct fetch...\n';
            
            try {
                log.textContent += `Fetching: ${currentApiUrl}\n`;
                const response = await fetch(currentApiUrl);
                log.textContent += `Status: ${response.status} ${response.statusText}\n`;
                log.textContent += `Headers: ${JSON.stringify([...response.headers])}\n`;
                
                const text = await response.text();
                log.textContent += `Response: ${text}\n`;
                
            } catch (error) {
                log.textContent += `Error: ${error.message}\n${error.stack}\n`;
            }
        }

        function testJsonp() {
            const log = document.getElementById('manualTestLog');
            log.textContent = 'Testing JSONP...\n';
            
            const callbackName = 'test_callback_' + Date.now();
            window[callbackName] = function(data) {
                log.textContent += `JSONP Success: ${JSON.stringify(data)}\n`;
                delete window[callbackName];
            };
            
            const script = document.createElement('script');
            script.src = `${currentApiUrl}?callback=${callbackName}`;
            script.onerror = function() {
                log.textContent += 'JSONP Error: Script failed to load\n';
            };
            
            document.body.appendChild(script);
        }

        async function testCorsProxy() {
            const log = document.getElementById('manualTestLog');
            log.textContent = 'Testing with CORS proxy...\n';
            
            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const targetUrl = encodeURIComponent(currentApiUrl);
                
                log.textContent += `Using proxy: ${proxyUrl}${targetUrl}\n`;
                
                const response = await fetch(proxyUrl + targetUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=test'
                });
                
                const text = await response.text();
                log.textContent += `Proxy Response: ${text}\n`;
                
            } catch (error) {
                log.textContent += `Proxy Error: ${error.message}\n`;
            }
        }

        // Run initial diagnostic
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(runFullDiagnostic, 1000);
        });
    </script>
</body>
</html>
